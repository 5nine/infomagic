<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <title>InfoMagic – Touch</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>

  <body class="touch-page">
    <div id="thumbs"></div>

    <div id="controls">
      <div class="btn" onclick="send('prev')">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
        </svg>
      </div>
      <div class="btn" onclick="send('toggle')">
        <svg
          id="play-icon"
          viewBox="0 0 24 24"
          fill="currentColor"
          width="64"
          height="64"
          style="display: none"
        >
          <path d="M8 5v14l11-7z" />
        </svg>
        <svg
          id="pause-icon"
          viewBox="0 0 24 24"
          fill="currentColor"
          width="64"
          height="64"
        >
          <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
        </svg>
      </div>
      <div class="btn" onclick="send('next')">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
        </svg>
      </div>
    </div>

    <script>
      let ws = null;

      /* ───── THUMBNAILS ───── */
      async function loadThumbs() {
        const imgs = await (await fetch('/api/images')).json();
        thumbs.innerHTML = '';
        imgs.forEach((img, idx) => {
          const d = document.createElement('button');
          d.className = 'thumb';
          d.dataset.index = idx;
          d.innerHTML = `<img src="${img.thumb}">`;
          d.onclick = () => {
            send(idx);
          };
          thumbs.appendChild(d);
        });
      }

      /* ───── SLIDESHOW CONTROL ───── */
      function send(action) {
        fetch('/api/slideshow', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action }),
        });
      }

      function updatePlayPauseIcon(playing) {
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        if (playing) {
          playIcon.style.display = 'none';
          pauseIcon.style.display = 'block';
        } else {
          playIcon.style.display = 'block';
          pauseIcon.style.display = 'none';
        }
      }

      /* ───── WEBSOCKET CONNECTION ───── */
      function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          console.log('WebSocket connected');
        };

        ws.onmessage = event => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'slideshow-state') {
              // Update play/pause icon based on state
              updatePlayPauseIcon(data.state.playing);
            }
          } catch (err) {
            console.error('Error parsing WebSocket message:', err);
          }
        };

        ws.onerror = err => {
          console.error('WebSocket error:', err);
        };

        ws.onclose = () => {
          console.log('WebSocket disconnected, reconnecting...');
          // Reconnect after 3 seconds
          setTimeout(connectWebSocket, 3000);
        };
      }

      /* ───── INIT ───── */
      loadThumbs();
      setInterval(loadThumbs, 60 * 1000);

      // Connect to WebSocket for real-time communication
      connectWebSocket();
    </script>
  </body>
</html>
