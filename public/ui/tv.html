<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<title>InfoMagic – TV</title>
<link rel="stylesheet" href="/styles.css">
</head>

<body class="tv-page">
<div id="layout">

  <div id="image">
    <div id="logo">
      <img src="/assets/sj_logo.png" alt="Själevadsbygg">
    </div>
    <img id="slide">
  </div>

  <div id="side">

    <div id="calendar-wrap">
      <iframe id="calendar"></iframe>
    </div>

    <div id="weather">
      <h3>Örnsköldsvik – 5 dagar</h3>
      <div id="weatherRows"></div>
    </div>

  </div>
</div>

<script>
let images = [];
let slideshowIntervalMs = 5000; // fallback
let lastAdvance = 0;
async function loadConfig(){
  const cfg = await (await fetch('/api/config')).json();
  slideshowIntervalMs = (cfg.slideshowInterval || 5) * 1000;
}
/* ───── BILDER ───── */
async function loadImages(){
  images = await (await fetch('/api/images')).json();
}

/* ───── SLIDESHOW (STATE I BACKEND) ───── */
async function updateSlide(){
  if(!images.length) return;

  const state = await (await fetch('/api/slideshow')).json();
  const idx = ((state.index % images.length) + images.length) % images.length;

  slide.src = images[idx].original;
  document.documentElement.style.setProperty(
    '--blur-image',
    `url(${images[idx].original})`
  );

	const now = Date.now();

	if(state.playing && now - lastAdvance >= slideshowIntervalMs){
	  await fetch('/api/slideshow',{
		method:'POST',
		headers:{'Content-Type':'application/json'},
		body:JSON.stringify({ action:'next' })
	  });
	  lastAdvance = now;
	}
}

/* ───── KALENDER ───── */
async function loadCalendar(){
  const cfg = await (await fetch('/api/config')).json();
  const p = new URLSearchParams({
    ctz:'Europe/Stockholm',
    mode:cfg.calendar.view,
    showTitle:0,
    showNav:0,
    showDate:0,
    showTabs:0,
    showCalendars:0,
    showTz:0,
    src:cfg.calendar.calendarId
  });
  calendar.src =
    'https://calendar.google.com/calendar/embed?' + p;
}

/* ───── VÄDER ───── */
async function loadWeather(){
  const data = await (await fetch('/api/weather')).json();
  weatherRows.innerHTML='';
  data.forEach(d=>{
    weatherRows.innerHTML+=`
      <div class="weather-day">
        <div class="weather-left">
          <svg class="weather-icon" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="5"/>
          </svg>
          ${d.date.slice(5)}
        </div>
        <div class="weather-mid">Vind ${Math.round(d.wind)} m/s</div>
        <div class="weather-right">
          ${Math.round(d.min)}° / ${Math.round(d.max)}°
        </div>
      </div>`;
  });
}

/* ───── INIT ───── */
(async()=>{
  await loadImages();
  await loadConfig();
  await updateSlide();
  lastAdvance = Date.now();

  setInterval(loadImages, 5000);
  setInterval(updateSlide, 1000);

  loadCalendar();
  loadWeather();
  setInterval(loadWeather, 30*60*1000);
})();
</script>
</body>
</html>
