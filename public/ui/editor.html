<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <title>InfoMagic – Redaktör</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body class="editor-page">
    <button class="logout-btn" onclick="logout()">Logga ut</button>

    <h1>Redaktör – Bilder</h1>

    <input type="file" id="files" multiple />
    <button onclick="upload()">Ladda upp</button>

    <hr />

    <h2>Bildspelsinställningar</h2>
    <div style="margin-bottom: 20px">
      <label for="interval-input">
        Intervall mellan bilder (sekunder):
      </label>
      <input
        type="number"
        id="interval-input"
        min="1"
        max="300"
        value="15"
        style="margin: 0 10px; padding: 5px; width: 80px"
      />
      <button onclick="saveInterval()">Spara intervall</button>
      <span id="interval-status" style="margin-left: 10px"></span>
    </div>

    <hr />

    <div class="grid" id="images"></div>

    <script>
      let imageList = [];
      let draggedElement = null;

      async function load() {
        imageList = await (await fetch('/api/images')).json();
        const g = document.getElementById('images');
        g.innerHTML = '';
        imageList.forEach((i, index) => {
          const d = document.createElement('div');
          d.className = 'thumb';
          d.draggable = true;
          d.dataset.index = index;
          d.innerHTML = `
      <img src="${i.thumb}">
      <button onclick="remove('${i.id}')">✕</button>
    `;

          // Add drag event listeners
          d.addEventListener('dragstart', handleDragStart);
          d.addEventListener('dragover', handleDragOver);
          d.addEventListener('drop', handleDrop);
          d.addEventListener('dragend', handleDragEnd);

          g.appendChild(d);
        });
      }

      function handleDragStart(e) {
        draggedElement = this;
        this.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
      }

      function handleDragOver(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
      }

      function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();

        if (draggedElement && draggedElement !== this) {
          const draggedIndex = parseInt(draggedElement.dataset.index);
          const targetIndex = parseInt(this.dataset.index);

          // Reorder the imageList array
          const [movedItem] = imageList.splice(draggedIndex, 1);
          imageList.splice(targetIndex, 0, movedItem);

          // Update the order on the server
          const order = imageList.map(img => img.id);
          fetch('/api/images/order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order }),
          });

          // Reload to reflect the new order
          load();
        }

        return false;
      }

      function handleDragEnd(e) {
        if (draggedElement) {
          draggedElement.style.opacity = '1';
          draggedElement = null;
        }
      }

      async function upload() {
        const f = document.getElementById('files').files;
        if (f.length === 0) {
          alert('Välj bilder att ladda upp');
          return;
        }
        
        const fd = new FormData();
        for (const file of f) fd.append('images', file);
        
        try {
          const response = await fetch('/api/images/upload', { method: 'POST', body: fd });
          const results = await response.json();
          
          // Check for errors
          const errors = results.filter(r => !r.ok);
          if (errors.length > 0) {
            const errorMsg = errors.map(e => `${e.file}: ${e.error}`).join('\n');
            alert('Några bilder kunde inte laddas upp:\n' + errorMsg);
          }
          
          load();
        } catch (err) {
          console.error('Upload error:', err);
          alert('Fel vid uppladdning: ' + err.message);
        }
      }

      async function remove(id) {
        await fetch('/api/images/' + id, { method: 'DELETE' });
        load();
      }

      async function logout() {
        await fetch('/logout', { method: 'POST' });
        window.location.href = '/';
      }

      async function loadConfig() {
        const cfg = await (await fetch('/api/config')).json();
        const intervalInput = document.getElementById('interval-input');
        intervalInput.value = cfg.slideshowInterval || 15;
      }

      async function saveInterval() {
        const intervalInput = document.getElementById('interval-input');
        const interval = parseInt(intervalInput.value);
        const statusEl = document.getElementById('interval-status');

        if (isNaN(interval) || interval < 1 || interval > 300) {
          statusEl.textContent = 'Ogiltigt intervall (1-300 sekunder)';
          statusEl.style.color = 'red';
          return;
        }

        try {
          const response = await fetch('/api/config/slideshow-interval', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ interval }),
          });

          if (response.ok) {
            statusEl.textContent = 'Sparat!';
            statusEl.style.color = 'green';
            setTimeout(() => {
              statusEl.textContent = '';
            }, 2000);
          } else {
            const data = await response.json();
            statusEl.textContent = data.error || 'Kunde inte spara';
            statusEl.style.color = 'red';
          }
        } catch (err) {
          statusEl.textContent = 'Fel vid sparande';
          statusEl.style.color = 'red';
        }
      }

      load();
      loadConfig();
    </script>
  </body>
</html>
